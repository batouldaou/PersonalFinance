{% extends 'layout.html' %}

{% block title %} Categories {% endblock %}

{% block main %}
<div class="container">
    <h2>Categories</h2>
    <form action="{{ url_for('category_manage') }}" method="POST" id="category-form">        
        <div class="form-group">
            <label for="category_name">New Category</label>
            <input type="text" class="form-control" id="category_name" name="category_name" required>    
        </div>
        <button type="submit" name="submit" value="add" class="btn btn-primary">Add Category</button>
    </form>
    <table class="table mt-3">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Category Name</th>
                <th scope="col"></th>
            </tr>
        </thead>
        <tbody id="category-table">
            {% for category in categories_list %}
            <tr data-category-id="{{ category.id }}">
                <td>{{ category.id }}</td>
                <td>{{ category.category_name }}</td>
                <td>
                    <button class="btn btn-light btn-edit" data-id="{{ category.id }}" data-name="{{ category.category_name }}">Edit</button>
                    <button class="btn btn-danger btn-delete" data-id="{{ category.id }}">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div id="edit-modal" class="modal" tabindex="-1" role="dialog" style="display: none;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Category</h5>
                    <button type="button" class="close" id="edit-cancel" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="edit-category-form">
                        <div class="form-group">
                            <label for="edit_category_name">Category Name</label>
                            <input type="text" class="form-control" id="edit_category_name" name="category_name" required>
                            <input type="hidden" id="edit_category_id" name="category_id">
                        </div>
                        <button type="submit" class="btn btn-secondary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    $(document).ready(function() {
        $('#category-form').on('submit', function(event) {
            event.preventDefault();
            $.ajax({
                url: "{{ url_for('category_manage') }}",
                method: "POST",
                data: $(this).serialize() + '&submit=add',
                success: function(response) {
                    if (response.error) {
                        alert('Error: ' + response.error);
                    } else {
                        $('#category-table').append(
                            '<tr data-category-id="' + response.id + '">' +
                                '<td>' + response.id + '</td>' +
                                '<td>' + response.name + '</td>' +
                                '<td>' +
                                '<button class="btn btn-light btn-edit" data-id="' + response.id + '" data-name="' + response.name + '">Edit</button>' +
                                '<button class="btn btn-danger btn-delete" data-id="' + response.id + '">Delete</button>' +
                                '</td>' +
                            '</tr>'
                        );
                        // Clear form fields
                        $('#category-form')[0].reset();
                    }
                },
                error: function(xhr, status, error) {
                    alert('An error occurred: ' + error);
                }
            });
        });


        $('#category-table').on('click', '.btn-delete', function(event) {
            event.preventDefault();
            var row = $(this).closest('tr');
            var categoryId = $(this).data('id');
            $.ajax({
                url: "{{ url_for('category_manage') }}",
                method: "POST",
                data: { category_id: categoryId, submit: 'delete' },
                success: function(response) {
                    if (response.success) {
                        row.remove();
                    } else {
                        alert('Delete failed: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    alert('An error occurred: ' + error);
                }
            });
        });

        // Show edit form
        $('#category-table').on('click', '.btn-edit', function() {
            var row = $(this).closest('tr');
            var categoryId = $(this).data('id');
            var categoryName = $(this).data('name');
            $('#edit_category_id').val(categoryId);
            $('#edit_category_name').val(categoryName);
            $('#edit-modal').show();
        });

        // Cancel edit
        $('#edit-cancel').on('click', function() {
            $('#edit-modal').hide();
            $('#edit-category-form')[0].reset();
        });

        // Edit category
        $('#edit-category-form').on('submit', function(event) {
            event.preventDefault();
            $.ajax({
                url: "{{ url_for('category_manage') }}",
                method: "POST",
                data: $(this).serialize() + '&submit=edit',
                success: function(response) {
                    if (response.error) {
                        alert('Error: ' + response.error);
                    } else {
                        var row = $('#category-table').find('tr[data-category-id="' + response.id + '"]');
                        row.find('td').eq(1).text(response.name);
                        $('#edit-modal').hide();
                        $('#edit-category-form')[0].reset();
                    }
                },
                error: function(xhr, status, error) {
                    alert('An error occurred: ' + error);
                }
            });
        });
    });
</script>

{% endblock %}
