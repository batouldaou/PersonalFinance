{% extends 'layout.html' %}

{% block title %} Budget {% endblock %}

{% block main %}
<div class="container">
    <h2>Budget</h2>
    <section id="description">
        <p> Assign the desired percentage of your income to your personalized category spending list.</p>
        <p> One budget per expense category </p>

    </section>
    {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="alert alert-primary mb-0 text-center" role="alert">
                    {{ messages | join(" ") }}
                </div>
            {% endif %}
    {% endwith %}
        
    <table class="table table-striped">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Category</th>
                <th scope="col">Budget percentage</th>
                <th scope="col">Budget amount</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody id="budget-table">
             {% for budget in list_budget %}
                <tr data-budget-id="{{ budget["id"] }}">
                    <td>{{ loop.index }}</td>
                    <td>{{ budget["category_name"] }}</td>
                    <td>{{ budget["budget_percent"] }}</td>
                    <td>{{ budget["budget_amount"] }}</td>
                    <td>
                        <button class="btn btn-light btn-edit" data-id="{{budget["id"] }}" data-percent="{{ budget.budget_percent }}">Edit</button>
                        <form action="{{ url_for('budget') }}" method="POST" style="display:inline;">
                            {{ form.hidden_tag() }}
                            <input type="hidden" name="budget_id" value="{{ budget["id"] }}">
                            <button type="submit" name="submit" value="Delete" class="btn btn-danger btn-delete" data-id="{{ budget["id"] }}">Delete</button>
                        </form>                   
                    </td>
                </tr>
             {% endfor %}
            <tr id="form-row">
                <form action="{{ url_for('budget') }}" id="budget-form" method="POST">
                    {{ form.hidden_tag() }}
                    <td></td>
                    <td>{{ form.category(class="form-control") }}</td>
                    <td>{{ form.percentage(class="form-control", size=32) }}</td>
                    <td></td>
                    <td>
                        <button type="submit" name="submit" value="add" class="btn btn-primary">Add</button>
                    </td>
                </form>
            </tr>
        </tbody>
    </table>

    <div id="edit-modal" class="modal" tabindex="-1" role="dialog" style="display: none;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Budget</h5>
                    <button type="button" class="close" id="edit-cancel" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="edit-budget_percent-form">
                        <div class="form-group">
                            <label for="edit_budget_percent">Budget Percent</label>
                            <input type="text" class="form-control" id="edit_budget_percent" name="budget_percent" required>
                            <input type="hidden" id="edit_budget_id" name="budget_id">
                        </div>
                        <button type="submit" class="btn btn-secondary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    $(document).ready(function() {
        $('#budget-form').on('submit', function(event) {
            event.preventDefault();
            $.ajax({
                url: "{{ url_for('budget') }}",
                method: "POST",
                data: $(this).serialize() + '&submit=add',
                success: function(response) {
                    if (response.redirect) {
                        window.location.href = response.redirect;
                    } else if (response.error) {
                        alert('Error: ' + response.error);
                    } else {
                        var rowCount = $('#budget-table tr').length;
                        $('#budget-table').append(
                            '<tr data-budget-id="' + response.id + '">' +
                                '<td>' + rowCount + '</td>' +
                                '<td>' + response.category_name + '</td>' +
                                '<td>' + response.budget_percent + '</td>' +
                                '<td>' + response.budget_amount + '</td>' +
                                '<td>' + 
                                '<button class="btn btn-light btn-edit" data-id="' + response.id + '" data-percent="' + response.budget_percent + '">Edit</button>' +
                                '<form action="{{ url_for('budget') }}" method="POST" style="display:inline;">'+
                                '<input type="hidden" name="budget_id" value="' + response.id + '">' +
                                '<button type="submit" name="submit" value="Delete" data-id="' + response.id + '" class="btn btn-danger btn-delete">Delete</button>' +
                                '</form></td>' +
                            '</tr>'
                        );
                        // Clear form fields
                        $('#budget-form')[0].reset();
                    }
                },
                error: function(xhr, status, error) {
                    alert('An error occurred: ' + error);
                }
            });
        });

        $('#budget-table').on('click', '.btn-delete', function(event) {
            event.preventDefault();
            var row = $(this).closest('tr');
            var budgetId = $(this).data('id');
            $.ajax({
                url: "{{ url_for('budget') }}",
                method: "POST",
                data: { budget_id: budgetId, submit: 'delete' },
                success: function(response) {
                    if (response.success) {
                        row.remove();
                        // Update display_order for all rows
                        $('#budget-table tr').each(function(index) {
                            $(this).find('td:first').text(index + 1);
                        });
                    } else {
                        alert('Delete failed: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    alert('An error occurred: ' + error);
                }
            });
        });

        // Show edit form
        $('#budget-table').on('click', '.btn-edit', function() {
            var row = $(this).closest('tr');
            var budgetId = $(this).data('id');
            var budgetPercent = $(this).data('percent');
            $('#edit_budget_id').val(budgetId);
            $('#edit_budget_percent').val(budgetPercent);
            $('#edit-modal').show();
        });

        // Cancel edit
        $('#edit-cancel').on('click', function() {
            $('#edit-modal').hide();
            $('#edit-budget_percent-form')[0].reset();
        });

        // Edit budget percent
        $('#edit-budget_percent-form').on('submit', function(event) {
            event.preventDefault();
            $.ajax({
                url: "{{ url_for('budget') }}",
                method: "POST",
                data: $(this).serialize() + '&submit=edit',
                success: function(response) {
                    if (response.error) {
                        alert('Error: ' + response.error);
                    } else {
                        var row = $('#budget-table').find('tr[data-budget-id="' + response.id + '"]');
                        row.find('td').eq(2).text(response.budget_percent);
                        row.find('td').eq(3).text(response.budget_amount);
                        $('#edit-modal').hide();
                        $('#edit-budget_percent-form')[0].reset();
                    }
                },
                error: function(xhr, status, error) {
                    alert('An error occurred: ' + error);
                }
            });
        });
    });
</script>
{% endblock %}
